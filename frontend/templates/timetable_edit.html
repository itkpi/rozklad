{% extends 'base.html' %}

{% block content %}
	<section class="timetable">
		<div class="container">
			{% for week in timetable %}
				<div class="week" id="w--{% cycle '1' '2' as week_number %}">
					{% for day in week %}
						{% cycle '1' '2' '3' '4' '5' '6' as day_number silent %}
						<div class="day{% if not day %} noday{% endif %}">
							<h1 class="day__title">{% cycle 'Понеділок' 'Вівторок' 'Середа' 'Четвер' "П'ятниця" 'Субота' %}</h1>
							<ul>
								{% for lesson in day %}
									{% cycle '1' '2' '3' '4' '5' '6' as number silent %}
									{% if lesson %}
										<li class="" data-week="{{ week_number }}" data-day="{{ day_number }}" data-lesson="{{ number }}" data-id="{{ lesson.id }}">
											<i class="edit"></i>
											<i class="type" data-type="{{ lesson.type }}"></i>
											<h1 class="lesson__title" data-id="{{ lesson.discipline.id }}">{{ lesson.discipline.name }}</h1>
											<p class="lesson__right">
													{% if type == 'groups' or type == 'teachers' %}
														{% for room in lesson.rooms.all %}
															<a href="/rooms/{{ room.id }}" data-id="{{ room.id }}">{{ room.name }}</a>
															<br>
														{% endfor %}
													{% else %}
														{% for group in lesson.groups.all %}
															<a href="/groups/{{ group.id }}" data-id="{{ group.id }}">{{ group.name|upper }}</a>
															<br>
														{% endfor %}
													{% endif %}
												</p>
												<p class="lesson__left">
													{% if type == 'groups' or type == 'rooms' %}
														{% for teacher in lesson.teachers.all %}
															<a href="/teachers/{{ teacher.id }}" data-id="{{ teacher.id }}">{{ teacher.short_name }}</a>
															<br>
														{% endfor %}
													{% else %}
														{% for group in lesson.groups.all %}
															<a href="/groups/{{ group.id }}" data-id="{{ group.id }}">{{ group.name|upper }}</a>
															<br>
														{% endfor %}
													{% endif %}
												</p>
										</li>
									{% else %}
										<li class="window" id="w{{ week_number }}d{{ day_number }}l{{ number }}" data-week="{{ week_number }}" data-day="{{ day_number }}" data-lesson="{{ number }}">
											<i class="plus"></i>
										</li>
									{% endif %}
								{% endfor %}
							</ul>
						</div>
					{% endfor %}
				</div>
				<div class="clear"></div>
			{% endfor %}
		</div>
	</section>
	<div id="overlay">
		<div id="edit" class="modal">
			<h1 class="maintitle">Редагування пари</h1>
			<i class="closeicon"></i>
			<div class="content">
				<select id="edit_lesson_type">
					<option value="None">Тип пари</option>
					<option value="0">Лекція</option>
					<option value="1">Практика</option>
					<option value="2">Лабораторна</option>
				</select>
				<label for="edit_lesson_teachers">Викладачі:</label>
				<div id="teachersblock"></div>
				<input type="text" id="edit_lesson_teachers" placeholder="Додати викладача">
				<label for="edit_lesson_rooms">Кабінети:</label>
				<div id="roomsblock"></div>
				<input type="text" id="edit_lesson_rooms" placeholder="Додати аудиторію">
				<p class="error">Перевірте правильність уведених даних</p>
				<button class="button close active" id="delete">Видалити</button>
				<button class="button" id="save_lesson">Зберегти</button>
			</div>
		</div>
		<div id="adding" class="modal">
			<h1 class="maintitle">Додавання пари</h1>
			<i class="closeicon"></i>
			<div class="content">
				<label for="edit_lesson_name">Назва пари:</label>
				<input type="text" id="edit_lesson_name">
				<p class="error">Перевірте правильність уведених даних</p>
				<button class="button" id="add_lesson">Додати</button>
				</div>
		</div>
		<div id="areyousure" class="modal">
			<h1 class="maintitle">Що саме зробити?</h1>
			<div class="content">
				<p>Є підозри, що ця пара у вас разом з іншими групами? <br>Тож що робити?</p>
				<div id="areyousure_proposal_list">
				</div>
				<button class="button" id="new_lesson">створити нову</button><br>
				<button class="button close" id="idontneedthisshit">відмінити</button><br>
			</div>
		</div>
	</div>
	<script>
		var data_preload = {{ initial_data|safe }}
		var lesson__right_arr = []
		var lesson__left_arr = []

		var current_week
		var current_day
		var current_number

		var current_lesson_id

		$(document).ready(function() {
			$('i.type[data-type="0"').attr("data-typename", "Лекція")
			$('i.type[data-type="1"').attr("data-typename", "Практика")
			$('i.type[data-type="2"').attr("data-typename", "Лабораторна")
			
			//open the modal by click on icon
			$(document).on("click", ".edit, .plus", function() {
				$("#edit_lesson_type").val("None")
				$("#edit_lesson_name, #edit_lesson_teachers, #edit_lesson_rooms").val("")
				$("#teachersblock, #roomsblock").empty()
				$("p.error").css("opacity", 0)
				$("#overlay").css("opacity", 1).fadeIn(300)
				
				current_week = parseInt($(this).parent().data("week"))
				current_day = parseInt($(this).parent().data("day"))
				current_number = parseInt($(this).parent().data("lesson"))
				
				var type = $(this).siblings(".type").data("type")
				var id_lesson = $(this).parent().find(".lesson__title").data("id")
				lesson__right_children = $(this).parent().find(".lesson__right a")
				lesson__right_arr = []
				for (i = 0; i < lesson__right_children.length; i++)
					lesson__right_arr.push($(lesson__right_children[i]).data("id"))
				lesson__left_children = $(this).parent().find(".lesson__left a")
				lesson__left_arr = []
				for (i = 0; i < lesson__left_children.length; i++)
					lesson__left_arr.push($(lesson__left_children[i]).data("id"))
				
				if ($(this).hasClass("edit")) {
					current_lesson_id = parseInt($(this).parent().data("id"))

					$("#edit.modal").css("opacity", 1).fadeIn(300)

					if (type == "None") 
						$("#edit_lesson_type").val("None")
					else
						$("#edit_lesson_type").val(type)
					teachersBlock = ""
					teacherName = ""
					for (i = 0; i < lesson__left_arr.length; i++) {
						for (j = 0; j < data_preload.teachers.length; j++)
							if (lesson__left_arr[i] == data_preload.teachers[j].id)
								teacherName = data_preload.teachers[j].name
						teachersBlock += '<span class="left" data-id="' + lesson__left_arr[i] + '">' + teacherName + '<a href="#" class="deletespan"></a></span>'
					}
					$("#teachersblock").html(teachersBlock)
					roomsBlock = ""
					roomName = ""
					for (i = 0; i < lesson__right_arr.length; i++) {
						for (j = 0; j < data_preload.rooms.length; j++)
							if (lesson__right_arr[i] == data_preload.rooms[j].id)
								roomName = data_preload.rooms[j].name
						roomsBlock += '<span class="right" data-id="' + lesson__right_arr[i] + '">' + roomName + '<a href="#" class="deletespan"></a></span>'
					}
					$("#roomsblock").html(roomsBlock)
				} else {
					$("#adding.modal").css("opacity", 1).fadeIn(300)
					$("#edit_lesson_name").removeClass("inputcorrect")
				}
			})

			//search for lesson name
			$("#edit_lesson_name").keyup(function() {
				if (($(this).val().length >= 2) && (!$("#edit_lesson_name").hasClass("inputcorrect"))) {
					$.ajax({
						method: "GET",
						url: "/disciplines/search/?search="  + $("#edit_lesson_name").val(),
						dataType: "json"
					}).done(function(data) {
						data = data.data
						$("#search_proposals ul li").remove()
						if (data.length == 0) {
							$("#search_proposals").fadeOut(300)
						} else {
							$("#search_proposals").fadeIn(300).css("opacity", 1).css({"opacity": 1, "top": $("#edit_lesson_name").offset().top + $("#edit_lesson_name").outerHeight()}).outerWidth($("#edit_lesson_name").outerWidth())
							data.forEach(function(entry) {
								li = $("<li>")
								a = $("<a>", {
									href: "#",
									class: "lesson_name",
									"data-id": entry.id
								})
								a.text(entry.name)
								li.append(a)
								$("#search_proposals ul").append(li)
							})
						}
					})
				} else {
					$("#search_proposals").fadeOut(300)
					$("#search_proposals ul li").remove()
				}
			})

			//search for teachers
			$("#edit_lesson_teachers").keyup(function() {
				if ($(this).val().length >= 2) {
					$.ajax({
						method: "GET",
						url: "/teachers/search/?search=" + $(this).val(),
						dataType: "json"
					}).done(function(data) {
						data = data.data
						$("#search_proposals ul li").remove()
						if (data.length == 0) {
							$("#search_proposals").fadeOut(300)
						} else {
							$("#search_proposals").fadeIn(300).css({"opacity": 1, "top": $("#edit_lesson_teachers").offset().top + $("#edit_lesson_teachers").outerHeight()}).outerWidth($("#edit_lesson_teachers").outerWidth())
							data.forEach(function(entry) {
								li = $("<li>")
								a = $("<a>", {
									href: "#",
									class: "teacher_name",
									"data-id": entry.id
								})
								a.text(entry.name)
								li.append(a)
								$("#search_proposals ul").append(li)
							})
						}
					})
				} else {
					$("#search_proposals").fadeOut(300)
					$("#search_proposals ul li").remove()
				}
			})

			//search for rooms
			$("#edit_lesson_rooms").keyup(function() {
				if ($(this).val().length >= 2) {
					$.ajax({
						method: "GET",
						url: "/rooms/search/?search="  + $(this).val(),
						dataType: "json"
					}).done(function(data) {
						data = data.data
						$("#search_proposals ul li").remove()
						if (data.length == 0) {
							$("#search_proposals").fadeOut(300)
						} else {
							$("#search_proposals").fadeIn(300).css({"opacity": 1, "top": $("#edit_lesson_rooms").offset().top + $("#edit_lesson_rooms").outerHeight()}).outerWidth($("#edit_lesson_rooms").outerWidth())
							data.forEach(function(entry) {
								li = $("<li>")
								a = $("<a>", {
									href: "#",
									class: "room_name",
									"data-id": entry.id
								})
								a.text(entry.name)
								li.append(a)
								$("#search_proposals ul").append(li)
							})
						}
					})
				} else {
					$("#search_proposals").fadeOut(300)
					$("#search_proposals ul li").remove()
				}
			})

			$(document).on("click", ".deletespan", function() {
				if ($(this).parent().hasClass("right")) {
					for (i = 0; i < lesson__right_arr.length; i++)
						if ($(this).parent().data("id") == lesson__right_arr[i])
							lesson__right_arr.splice(i, i + 1)
				} else {
					for (i = 0; i < lesson__left_arr.length; i++)
						if ($(this).parent().data("id") == lesson__left_arr[i])
							lesson__left_arr.splice(i, i + 1)
				}
				($(this).parent().siblings.length == 1) ? $(this).parent().parent().empty() : $(this).parent().remove()
			})
			//choose of modal proposals
			$(document).on("click", "#search_proposals a", function() {
				if ($(this).hasClass("lesson_name")) {
					$("#edit_lesson_name").val($(this).text())

					$("#edit_lesson_name").addClass("inputcorrect").attr("data-id", $(this).data("id"))
				}
				else if ($(this).hasClass("room_name")) {
					isAlreadyTaken = false
					for (i = 0; i < lesson__right_arr[i]; i++)
						if 	(lesson__right_arr[i] == $(this).data("id")) 
							isAlreadyTaken = true
					if (!isAlreadyTaken) {
						$("#roomsblock").append('<span class="right" contenteditable="false" data-id="' + $(this).data("id") + '">' + $(this).text() + '<a href="#" class="deletespan"></a></span>')
						lesson__right_arr.push($(this).data("id"))
					}
					$("#edit_lesson_rooms").val('')
				} else {
					isAlreadyTaken = false
					for (i = 0; i < lesson__left_arr[i]; i++)
						if 	(lesson__left_arr[i] == $(this).data("id")) 
							isAlreadyTaken = true
					if (!isAlreadyTaken) {
						$("#teachersblock").append('<span class="left" contenteditable="false" data-id="' + $(this).data("id") + '">' + $(this).text() + '<a href="#" class="deletespan"></a></span>')
						lesson__left_arr.push($(this).data("id"))
					}
					$("#edit_lesson_teachers").val('')
				}
				$("#search_proposals").fadeOut(300)
				$("#search_proposals ul li").remove()
			})

			$("#edit_lesson_name").keyup(function(e){
				if ($(this).hasClass("inputcorrect")) {
					$("#search_proposals").addClass("noday")
					$(this).removeClass("inputcorrect").val("").removeData("id")
					$("#search_proposals").fadeOut(300)
					$("#search_proposals ul li").remove()
					$("#search_proposals").removeClass("noday")
				}
			})

			$(document).on("click", "#areyousure .close", function() {
				$("#areyousure").fadeOut(300)
				$(".modal").animate({"opacity": 1}, 300)
			})

			$(document).on("click", "#add_lesson", function() {
				if (!$("#edit_lesson_name").data("id")) {
					$(".error").text("Введіть та виберіть с випадаючого списку назву пари")
					$(".error").animate({opacity: 1}, 400)
				} else {
					var ajax_data = {
						sender: "group", //потом сделаем и для teacher
						id: {{ id }},
						discipline_id: parseInt($("#edit_lesson_name").data("id")),
						week: current_week,
						day: current_day,
						number: current_number,
						y: 0,
					}

					$.ajax({
						method: "POST",
						url: "/create-lesson/",
						dataType: "json",
						data: JSON.stringify(ajax_data),
						contentType: "application/json",
						headers: {
							"X-CSRFToken": "{{ csrf_token }}"
						}
					}).done(function(data) {
						if (data.status) {
							if (data.status == "OK") {
								location.reload()
							} else if (data.status == "CAN_LINK") {
								$("#areyousure_proposal_list").html("")

								for (var i = 0; i < data.lessons.length; i++) {
									var lesson_type = "None"
									if (data.lessons[i].type != null) {
										lesson_type = data.lessons[i].type
									}

									var lesson__right_html = ""
									for (var j = 0; j < data.lessons[i].room_names.length; j++) {
										lesson__right_html += data.lessons[i].room_names[j] + "<br>"
									}

									var lesson__left_html = ""
									for (var j = 0; j < data.lessons[i].teacher_names.length; j++) {
										lesson__left_html += data.lessons[i].teacher_names[j] + "<br>"
									}

									var lesson_proposal_div = $("<div>", {
										class: "day"
									}).append($("<ul>").append($("<li>").append($("<h1>", {
										class: "lesson__title"
									}).text(data.lessons[i].discipline_name)).append($("<p>", {
										class: "lesson__right"
									}).html(lesson__right_html)).append($("<p>", {
										class: "lesson__left"
									}).html(lesson__left_html))))

									if (lesson_type == 0) {
										lesson_proposal_div.children("ul").children("li").prepend($("<i>", {
											class: "type",
											"data-type": 0,
											"data-typename": "Лекція"
										}).on("mousemove", mousemove_tooltip_event_handler).on("mouseout", mouseout_tooltip_event_handler))
									} else if (lesson_type == 1) {
										lesson_proposal_div.children("ul").children("li").prepend($("<i>", {
											class: "type",
											"data-type": 1,
											"data-typename": "Практика"
										}).on("mousemove", mousemove_tooltip_event_handler).on("mouseout", mouseout_tooltip_event_handler))
									} else if (lesson_type == 2) {
										lesson_proposal_div.children("ul").children("li").prepend($("<i>", {
											class: "type",
											"data-type": 2,
											"data-typename": "Лабораторна"
										}).on("mousemove", mousemove_tooltip_event_handler).on("mouseout", mouseout_tooltip_event_handler))
									}

									$("#areyousure_proposal_list").append(lesson_proposal_div)

									var group_str = ""
									for (var j = 0; j < data.lessons[i].group_names.length; j++) {
										group_str += data.lessons[i].group_names[j].toUpperCase()
										if (j != data.lessons[i].group_names.length - 1) {
											group_str += ", "
										}
									}

									var lesson_proposal_ul = $("<ul>", {
										class: "groups"
									}).append($("<li>").append($("<span>", {
										class: "groupname"
									}).text(group_str)).append($("<button>", {
										class: "button merge_lesson",
										"data-id": data.lessons[i].id
									}).text("поєднати")))

									$("#areyousure_proposal_list").append(lesson_proposal_ul)
								}

								$("#areyousure").fadeIn("300")
								$("#modal").animate({"opacity": 0.6}, 300)
							} else {
								$(".error").text("Невідома помилка")
								$(".error").animate({opacity: 1}, 400)
							}
						} else {
							$(".error").text("Невідома помилка")
							$(".error").animate({opacity: 1}, 400)
						}
					}).fail(function() {
						$(".error").text("Невідома помилка")
						$(".error").animate({opacity: 1}, 400)
					})
				}
			})

			$(document).on("click", "#save_lesson", function() {
				var teacher_id_array = Array()
				var teachers_block = $("#teachersblock span")
				for (var i = 0; i < teachers_block.length; i++) {
					teacher_id_array.push($(teachers_block[i]).data("id"))
				}
				
				var room_id_array = Array()
				var rooms_block = $("#roomsblock span")
				for (var i = 0; i < rooms_block.length; i++) {
					room_id_array.push($(rooms_block[i]).data("id"))
				}

				var ajax_data = {
					sender: "group", //потом сделаем и для teacher
					id: {{ id }},
					lesson_id: current_lesson_id,
					lesson_type: $("#edit_lesson_type").val(),
					teachers_id: teacher_id_array,
					rooms_id: room_id_array,
				}

				$.ajax({
					method: "POST",
					url: "/edit-lesson/",
					dataType: "json",
					data: JSON.stringify(ajax_data),
					contentType: "application/json",
					headers: {
						"X-CSRFToken": "{{ csrf_token }}"
					}
				}).done(function(data) {
					if (data.status) {
						if (data.status == "OK") {
							location.reload()
						} else if (data.status == "ERROR") {
							var error_text
							
							if (data.error_code == 0) {
								error_text = "Викладач " + data.teacher_name + " вже зайнятий на цій парі "
							} else {
								error_text = "Аудиторія " + data.room_name + " вже зайнята на цій парі"
							}

							$(".error").text(error_text)
							$(".error").animate({opacity: 1}, 400)
						} else {
							$(".error").text("Невідома помилка")
							$(".error").animate({opacity: 1}, 400)
						}
					} else {
						$(".error").text("Невідома помилка")
						$(".error").animate({opacity: 1}, 400)
					}
				}).fail(function() {
					$(".error").text("Невідома помилка")
					$(".error").animate({opacity: 1}, 400)
				})
			})

			$(document).on("click", "#delete", function() {
				var ajax_data = {
					sender: "group", //потом сделаем и для teacher
					id: {{ id }},
					lesson_id: current_lesson_id,
				}

				$.ajax({
					method: "POST",
					url: "/remove-lesson/",
					dataType: "json",
					data: JSON.stringify(ajax_data),
					contentType: "application/json",
					headers: {
						"X-CSRFToken": "{{ csrf_token }}"
					}
				}).done(function(data) {
					if (data.status) {
						if (data.status == "OK") {
							location.reload()
						} else {
							$(".error").text("Невідома помилка")
							$(".error").animate({opacity: 1}, 400)
						}
					} else {
						$(".error").text("Невідома помилка")
						$(".error").animate({opacity: 1}, 400)
					}
				}).fail(function() {
					$(".error").text("Невідома помилка")
					$(".error").animate({opacity: 1}, 400)
				})
			})

			$(document).on("click", ".merge_lesson", function() {
				var ajax_data = {
					sender: "group", //потом сделаем и для teacher
					id: {{ id }},
					lesson_id: parseInt($(this).data("id")),
				}

				$.ajax({
					method: "POST",
					url: "/link-lesson/",
					dataType: "json",
					data: JSON.stringify(ajax_data),
					contentType: "application/json",
					headers: {
						"X-CSRFToken": "{{ csrf_token }}"
					}
				}).done(function(data) {
					location.reload()
				})
			})

			$(document).on("click", "#new_lesson", function() {
				var ajax_data = {
					sender: "group", //потом сделаем и для teacher
					id: {{ id }},
					discipline_id: parseInt($("#edit_lesson_name").data("id")),
					week: current_week,
					day: current_day,
					number: current_number,
					y: 1,
				}

				$.ajax({
					method: "POST",
					url: "/create-lesson/",
					dataType: "json",
					data: JSON.stringify(ajax_data),
					contentType: "application/json",
					headers: {
						"X-CSRFToken": "{{ csrf_token }}"
					}
				}).done(function(data) {
					location.reload()
				})
			})
		})
	</script>
{% endblock %}
