<!DOCTYPE html>
<html lang="uk">
	<head>
		<title>Розклад КПІ</title>
		<link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,300italic,700&subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="/static/css/normalize.css">
		<link rel="stylesheet" href="/static/css/style.css">
		<link rel="stylesheet" href="/static/css/responsive.css">
		<link rel="shortcut icon" href="/static/img/favicon.ico" type="image/x-icon">
		<link rel="icon" href="/static/img/favicon.ico" type="image/x-icon">
		<meta name="format-detection" content="telephone=no">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<!-- <link rel="stylesheet" href="../static/css/style.css"> -->
		<meta charset="utf-8">
		<script src="/static/js/jquery-2.1.4.min.js"></script>
	</head>
	<body>
		<header>
			<div class="container">
				<div id="logo">
					<a href="/">Новий Розклад КПІ</a>
				</div>
				<form action="" id="searchbar">
					<select name="">
						<option class="groups" value="groups" selected="selected">Група</option>
						<option class="teachers" value="teachers">Викладач</option>
						<option class="rooms" value="rooms">Аудиторія</option>
						<option class="disciplines" value="disciplines">Предмет</option>
					</select>
					<input type="text" placeholder="Введіть запит" name="" id="search__input" autocomplete="off">
					<button class="button">знайти</button>
				</form>
				{% if user.is_authenticated %}
					<a href="#" class="login exit">Вийти</a>
					<span class="login">{{ user.get_username }}</span>
				{% else %}
					<a href="#" class="login">Увійти</a>
				{% endif %}
				<div class="clear"></div>
			</div>
		</header>
		<div id="search_proposals">
			<ul>
			</ul>
		</div>
			{% block content %}{% endblock %}
		<p>&nbsp;</p>
		<footer>
			<div class="container">
				<div class="links">
					<a href="#">API</a>
				</div>
				<div class="createdby">
					created by <a href="http://vk.com/antontimenko">Anton Timenko</a>, <a href="http://vk.com/vladkampov">Vlad Kampov</a> and <a href="http://vk.com/vlad_sidorenko">Vlad Sidorenko</a>
				</div>
				<div class="clear"></div>
			</div>
		</footer>
		{% if not user.is_authenticated %}
		<div id="overlay" class="modal_login">
			<div id="modal">
				<h1 class="maintitle">Вікно логіну</h1>
				<i id="close"></i>
				<div class="content">
					<input type="text" placeholder="Ім'я користувача" id="login_username_input">
					<input type="password" placeholder="Пароль" id="login_password_input">
					<p class="error">Перевірте правильність уведених даних</p>
					<!-- <button name="" class="button close">закрити</button> -->
					<button name="" class="button" id="login_button">Увійти</button>
				</div>
			</div>
		</div>
		{% endif %}
		<script>
			$(document).ready(function() {
				$('#search_proposals').css({
					top: $('header').height() * 1.1
				})
				$("#search__input").keyup(function() {
					api_link = "http://{{ base.api_domain }}/"
					base_url = '/' + $('#searchbar option:selected').attr("class") + '/'
					base_api_url = api_link + $('#searchbar option:selected').attr("class") + '/?search='
					if ($(this).val().length >= 2) {
						$.ajax({
							method: "GET",
							url: base_api_url + $("#search__input").val(),
							dataType: "json"
						}).done(function(data) {
							$('#search_proposals ul li').remove()
							if (data.results.length == 0) {
								$('#search_proposals').fadeOut(300)
							} else {
								$('#search_proposals').fadeIn(300)
								data.results.forEach(function(entry) {
									li = $('<li>')
									a = $('<a>', {
										href: base_url + entry.id + '/'
									})
									a.text(entry.name)
									li.append(a)
									$('#search_proposals ul').append(li)
								})
								
								$('#searchbar').attr('action', base_url + data.results[0].id) + '/'
							}
						})
					} else {
						$('#search_proposals').fadeOut(300)
						$('#search_proposals ul li').remove()
					}
				})
			})
		</script>
		<script>
			$(document).ready(function() {
				{% if not user.is_authenticated %}
					$('.login').click(function(){
						$('#overlay').css('opacity', 1).fadeIn(300)
					})
				{% endif %}
				$('#close').click(function(){
					$('#overlay').animate({opacity: 0}, 300, function() {$(this).hide()})
					$('#search_proposals').animate({opacity: 0}, 300, function() {$(this).hide()})
					return false
				})

				$("#login_button").click(function() {
					$.ajax({
						method: "POST",
						url: "/login/",
						dataType: "json",
						data: {
							username: $("#login_username_input").val(),
							password: $("#login_password_input").val()
						}
					}).done(function(data) {
						if (data.result == "OK") {
							window.location.reload()
						}
						if (data.result == "ERROR") {
							$('.error').animate({opacity: 1}, 400)
						}
					})
				})
				$('.exit').click(function() {
					$.ajax({
						methond: "POST",
						url: "/logout/",
						dataType: "json"
					}).done(function(data) {
						if (data.result == "OK") {
							window.location.reload()
						}
					})
				})
			})
		</script>
	</body>
</html>